<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}MindBloom{% endblock %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  {% block head %}{% endblock %}

  <style>
    .dark-mode {
      background-color: #1a1a1a;
      color: #f8f9fa;
    }
    .dark-mode .navbar,
    .dark-mode .dropdown-menu {
      background-color: #212529 !important;
    }
    .nav-link.rounded-circle {
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    .nav-link.rounded-circle:hover {
      background-color: rgba(0,0,0,0.05);
    }
    .color-dot {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #dee2e6;
      cursor: pointer;
    }
    .form-check-input:checked + label .color-dot {
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #0d6efd;
    }
    .bg-blue { background-color: #0d6efd; }
    .bg-green { background-color: #198754; }
    .bg-purple { background-color: #6f42c1; }
    .bg-orange { background-color: #fd7e14; }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
  </style>
</head>
<body data-accent-color="{{ current_user.accent_color if current_user.is_authenticated else 'primary' }}">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-seedling"></i> MindBloom</a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav ms-auto">
          {% for name, url, icon in nav_items %}
            <li class="nav-item">
              <a class="nav-link {% if request.path == url %}active{% endif %}" href="{{ url }}">
                <i class="fa-solid fa-{{ icon }}"></i> {{ name }}
              </a>
            </li>
          {% endfor %}

          <li class="nav-item dropdown">
            <a class="nav-link rounded-circle p-1" href="#" id="userDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false" style="width: 36px; height: 36px;">
              <i class="fa-solid fa-user-gear d-flex justify-content-center align-items-center"
                 style="font-size: 1.1rem;"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><h6 class="dropdown-header">App Features</h6></li>
              <li>
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
                  <i class="fa-solid fa-sliders me-2 text-info"></i> Settings
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" id="darkModeToggle">
                  <i class="fa-solid fa-moon me-2 text-secondary"></i> Dark Mode
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li><h6 class="dropdown-header">Help & Support</h6></li>
              <li>
                <a class="dropdown-item" href="{{ url_for('main.help') }}">
                  <i class="fa-solid fa-circle-question me-2 text-success"></i> Help Center
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                  <i class="fa-solid fa-comment-dots me-2 text-primary"></i> Send Feedback
                </a>
              </li>
              {% if current_user.is_authenticated %}
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                    <i class="fa-solid fa-user-pen me-2 text-primary"></i> Edit Profile
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                    <i class="fa-solid fa-key me-2 text-warning"></i> Change Password
                  </a>
                </li>
                <li>
                  <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                    <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
                  </a>
                </li>
              {% endif %}
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    {% block content %}{% endblock %}
  </main>

  <!-- Modals -->
  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-user-pen me-2"></i>Edit Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="POST" action="{{ url_for('auth.edit_profile') }}">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" name="fullname" value="{{ current_user.fullname }}" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" value="{{ current_user.email }}" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-key me-2"></i>Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="POST" action="{{ url_for('auth.change_password') }}">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input type="password" class="form-control" name="current_password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" class="form-control" name="new_password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" name="confirm_password" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-warning">Update Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-comment-dots me-2"></i>Send Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="POST" action="{{ url_for('main.feedback') }}">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
              <label class="form-label">Your Feedback</label>
              <textarea class="form-control" rows="4" name="feedback" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Settings Modal with Complete Tab Content -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-sliders me-2"></i>App Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="account-tab" data-bs-toggle="tab"
                      data-bs-target="#account" type="button" role="tab"
                      aria-controls="account" aria-selected="true">
                <i class="fa-solid fa-user me-2"></i>Account
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="notifications-tab" data-bs-toggle="tab"
                      data-bs-target="#notifications" type="button" role="tab"
                      aria-controls="notifications" aria-selected="false">
                <i class="fa-solid fa-bell me-2"></i>Notifications
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="privacy-tab" data-bs-toggle="tab"
                      data-bs-target="#privacy" type="button" role="tab"
                      aria-controls="privacy" aria-selected="false">
                <i class="fa-solid fa-shield me-2"></i>Privacy
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="theme-tab" data-bs-toggle="tab"
                      data-bs-target="#theme" type="button" role="tab"
                      aria-controls="theme" aria-selected="false">
                <i class="fa-solid fa-palette me-2"></i>Theme
              </button>
            </li>
          </ul>

          <div class="tab-content" id="settingsContent">
            <!-- Account Settings -->
            <div class="tab-pane fade show active" id="account" role="tabpanel" aria-labelledby="account-tab">
              <form method="POST" action="{{ url_for('main.settings') }}" novalidate>
                <input type="hidden" name="settings_type" value="account">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                  <label class="form-label">Display Name</label>
                  <input type="text" class="form-control" name="display_name"
                         value="{{ current_user.display_name or current_user.username }}">
                </div>

                <div class="mb-3">
                  <label class="form-label">Email Address</label>
                  <input type="email" class="form-control" name="email"
                         value="{{ current_user.email }}">
                </div>

                <div class="mb-3 form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="emailVisibility"
                         name="email_visible" {% if current_user.email_visible %}checked{% endif %}>
                  <label class="form-check-label" for="emailVisibility">
                    Make email visible to other users
                  </label>
                </div>

                <button type="submit" class="btn btn-primary">Save Account Settings</button>
              </form>
            </div>

            <!-- Notification Settings -->
            <div class="tab-pane fade" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
              <form method="POST" action="{{ url_for('main.settings') }}" novalidate>
                <input type="hidden" name="settings_type" value="notifications">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                  <h6 class="mb-3">Notification Preferences</h6>

                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="emailNotifications"
                           name="email_notifications" {% if current_user.email_notifications %}checked{% endif %}>
                    <label class="form-check-label" for="emailNotifications">
                      Email Notifications
                    </label>
                  </div>

                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="pushNotifications"
                           name="push_notifications" {% if current_user.push_notifications %}checked{% endif %}>
                    <label class="form-check-label" for="pushNotifications">
                      Push Notifications
                    </label>
                  </div>

                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="reminderEmails"
                           name="reminder_emails" {% if current_user.reminder_emails %}checked{% endif %}>
                    <label class="form-check-label" for="reminderEmails">
                      Daily Reminder Emails
                    </label>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Notification Frequency</label>
                  <select class="form-select" name="notification_frequency">
                    <option value="instant" {% if current_user.notification_frequency == 'instant' %}selected{% endif %}>
                      Instant
                    </option>
                    <option value="daily" {% if current_user.notification_frequency == 'daily' %}selected{% endif %}>
                      Daily Digest
                    </option>
                    <option value="weekly" {% if current_user.notification_frequency == 'weekly' %}selected{% endif %}>
                      Weekly Summary
                    </option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary">Save Notification Settings</button>
              </form>
            </div>

            <!-- Privacy Settings -->
            <div class="tab-pane fade" id="privacy" role="tabpanel" aria-labelledby="privacy-tab">
              <form method="POST" action="{{ url_for('main.settings') }}" novalidate>
                <input type="hidden" name="settings_type" value="privacy">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                  <h6 class="mb-3">Profile Visibility</h6>

                  <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="profile_visibility"
                           id="visibilityPublic" value="public"
                           {% if current_user.profile_visibility == 'public' %}checked{% endif %}>
                    <label class="form-check-label" for="visibilityPublic">
                      Public (Visible to everyone)
                    </label>
                  </div>

                  <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="profile_visibility"
                           id="visibilityPrivate" value="private"
                           {% if current_user.profile_visibility == 'private' %}checked{% endif %}>
                    <label class="form-check-label" for="visibilityPrivate">
                      Private (Only visible to me)
                    </label>
                  </div>
                </div>

                <div class="mb-3">
                  <h6 class="mb-3">Data Collection</h6>

                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="analyticsTracking"
                           name="analytics_tracking" {% if current_user.analytics_tracking %}checked{% endif %}>
                    <label class="form-check-label" for="analyticsTracking">
                      Allow anonymous usage analytics
                    </label>
                  </div>

                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="personalizedAds"
                           name="personalized_ads" {% if current_user.personalized_ads %}checked{% endif %}>
                    <label class="form-check-label" for="personalizedAds">
                      Personalized advertisements
                    </label>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary">Save Privacy Settings</button>
              </form>
            </div>

            <!-- Theme Settings -->
            <div class="tab-pane fade" id="theme" role="tabpanel" aria-labelledby="theme-tab">
              <form method="POST" action="{{ url_for('main.settings') }}" novalidate>
                <input type="hidden" name="settings_type" value="theme">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                  <label class="form-label">Theme Preference</label>
                  <select class="form-select" name="theme_preference" id="themeSelect">
                    <option value="system" {% if current_user.theme_preference == 'system' %}selected{% endif %}>
                      Match System Setting
                    </option>
                    <option value="light" {% if current_user.theme_preference == 'light' %}selected{% endif %}>
                      Light Mode
                    </option>
                    <option value="dark" {% if current_user.theme_preference == 'dark' %}selected{% endif %}>
                      Dark Mode
                    </option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Accent Color</label>
                  <div class="d-flex gap-2">
                    {% for color in ['primary', 'blue', 'green', 'purple', 'orange'] %}
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="accent_color"
                             id="color{{ color }}" value="{{ color }}"
                             {% if current_user.accent_color == color %}checked{% endif %}>
                      <label class="form-check-label" for="color{{ color }}">
                        <span class="color-dot bg-{{ color }}"></span>
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                </div>

                <button type="submit" class="btn btn-primary">Save Theme Settings</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="social-icons mb-2">
        {% for name, link, icon in social_links %}
          <a href="{{ link }}" target="_blank" title="MindBloom {{ name }}">
            <i class="fab fa-{{ icon }}"></i>
          </a>
        {% endfor %}
      </div>
      &copy; {{ year|default(2024) }} MindBloom. All rights reserved.
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize all Bootstrap components
      if (typeof bootstrap !== 'undefined') {
        // Initialize dropdowns
        var dropdowns = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
        dropdowns.forEach(function(el) {
          new bootstrap.Dropdown(el);
        });

        // Initialize navbar toggler
        var navbarToggler = document.querySelector('.navbar-toggler');
        if (navbarToggler) {
          navbarToggler.addEventListener('click', function() {
            var target = this.getAttribute('data-bs-target');
            document.querySelector(target).classList.toggle('show');
          });
        }

        // Initialize tabs
        var tabEls = [].slice.call(document.querySelectorAll('[data-bs-toggle="tab"]'));
        tabEls.forEach(function(tabEl) {
          tabEl.addEventListener('click', function(e) {
            e.preventDefault();
            new bootstrap.Tab(tabEl).show();
          });
        });

        // Initialize modals
        var modalEls = [].slice.call(document.querySelectorAll('.modal'));
        modalEls.forEach(function(modalEl) {
          new bootstrap.Modal(modalEl);
        });
      }

      // Dark mode toggle
      document.getElementById('darkModeToggle')?.addEventListener('click', function(e) {
        e.preventDefault();
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDark);
      });

      // Form validation
      document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
          if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
          }
          form.classList.add('was-validated');
        });
      });

      // Load dark mode preference
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }

      // Theme selector handler
      document.getElementById('themeSelect')?.addEventListener('change', function() {
        document.body.classList.remove('dark-mode', 'light-mode');
        if(this.value === 'dark') {
          document.body.classList.add('dark-mode');
        } else if(this.value === 'light') {
          document.body.classList.add('light-mode');
        }
      });
    });
  </script>
</body>
</html>
